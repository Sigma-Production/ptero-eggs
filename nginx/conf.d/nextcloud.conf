# Nginx configuration for Nextcloud
# Based on the official recommendations

# Set max upload size
client_max_body_size 10G;
fastcgi_buffers 64 4K;

# Specify mapping for mjs files
types {
    application/javascript mjs;
}

# HSTS - Enable this after you have confirmed HTTPS is working
# add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;

server {
    listen 80 default_server;
    server_name _;

    root /home/container/webroot;
    index index.php index.html;

    # Return 404 for all other files not matching the patterns below
    location ~ ^/(?:build|tests|config|lib|3rdparty|templates)/ {
        return 404;
    }
    location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) {
        return 404;
    }

    # Deny access to sensitive files and directories
    location ~ ^/(data|config|\.ht|db_structure\.xml|README) {
        deny all;
    }

    # Handle .well-known URLs for CalDAV and CardDAV
    location /.well-known/carddav {
        return 301 $scheme://$host/remote.php/dav;
    }
    location /.well-known/caldav {
        return 301 $scheme://$host/remote.php/dav;
    }

    # Main location block
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # PHP-FPM configuration
    location ~ \.php(?:$|/) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        set $path_info $fastcgi_path_info;
        
        try_files $fastcgi_script_name =404;
        
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param modHeadersAvailable true; # For modern headers
        fastcgi_param front_controller_active true;
        
        # Connect to PHP-FPM service (usually on port 9000 for these images)
        fastcgi_pass 127.0.0.1:9000;
        
        fastcgi_intercept_errors on;
        fastcgi_request_buffering off;
    }
}
